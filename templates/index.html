<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAN Bus IDS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* A more refined and professional color scheme and animation */
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        .status-normal { background: linear-gradient(45deg, #10b981, #34d399); box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
        .status-attack { background: linear-gradient(45deg, #ef4444, #f87171); box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        .status-idle { background-color: #4b5563; }
        .correct { color: #4ade80; }
        .incorrect { color: #f87171; }
        .pulse { animation: pulse-animation 1.5s infinite; }
        @keyframes pulse-animation {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 15px 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">
    <div class="container mx-auto p-4 md:p-6 max-w-screen-2xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                CAN Bus Intrusion Detection System
            </h1>
            <p class="text-gray-500 mt-2">Real-Time Vehicle Network Security Dashboard</p>
        </header>

        <!-- Control Panel -->
        <div class="bg-gray-800/50 backdrop-blur-sm p-4 rounded-xl shadow-lg mb-8 flex flex-wrap items-center justify-center gap-4 border border-gray-700">
            <div>
                <label for="model-select" class="block text-sm font-medium text-gray-400 mb-1">Select Model</label>
                <select id="model-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    <option value="random_forest">Random Forest</option>
                    <option value="lstm" disabled>LSTM (Coming Soon)</option>
                </select>
            </div>
            <div>
                <label for="dataset-select" class="block text-sm font-medium text-gray-400 mb-1">Select Dataset</label>
                <select id="dataset-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    <option value="shuffled_features.csv">Shuffled Simulation Data</option>
                </select>
            </div>
            <div class="flex items-end gap-2">
                <button id="start-button" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg transition duration-300 shadow-md">Start</button>
                <button id="stop-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg transition duration-300 shadow-md" disabled>Stop</button>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Live Status & Metrics -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-gray-400">Live System Status</h2>
                    <div id="status-box" class="p-6 rounded-lg text-center transition-all duration-300 status-idle">
                        <p id="status-text" class="text-3xl font-bold text-white">IDLE</p>
                    </div>
                </div>
                <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700">
                     <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <h3 class="text-gray-500 text-sm uppercase">True Label</h3>
                            <p id="true-label" class="text-lg font-semibold">-</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <h3 class="text-gray-500 text-sm uppercase">Result</h3>
                            <p id="result-text" class="text-lg font-bold">-</p>
                        </div>
                    </div>
                </div>
                 <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700">
                     <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <h3 class="text-gray-500 text-sm font-bold uppercase">Windows Analyzed</h3>
                            <p id="total-windows" class="text-4xl font-bold text-cyan-400">0</p>
                        </div>
                         <div class="text-center">
                            <h3 class="text-gray-500 text-sm font-bold uppercase">Live Accuracy</h3>
                            <p id="accuracy" class="text-4xl font-bold text-cyan-400">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Columns: Chart and Log -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                 <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700 flex-1">
                     <h2 class="text-xl font-semibold mb-4 text-gray-400">Detection Summary</h2>
                     <div class="relative h-64"><canvas id="detection-chart"></canvas></div>
                 </div>
                 <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700 flex-1">
                     <h2 class="text-xl font-semibold mb-4 text-gray-400">Real-Time Event Log</h2>
                     <div class="h-64 overflow-y-auto bg-gray-900/50 p-2 rounded-md">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-cyan-400 uppercase bg-gray-700/50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-2 rounded-l-md">Time</th>
                                    <th scope="col" class="px-4 py-2">Prediction</th>
                                    <th scope="col" class="px-4 py-2">Actual</th>
                                    <th scope="col" class="px-4 py-2 rounded-r-md">Result</th>
                                </tr>
                            </thead>
                            <tbody id="event-log"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();

            // --- DOM Elements ---
            const statusBox = document.getElementById('status-box');
            const statusText = document.getElementById('status-text');
            const trueLabelEl = document.getElementById('true-label');
            const resultTextEl = document.getElementById('result-text');
            const totalWindowsEl = document.getElementById('total-windows');
            const accuracyEl = document.getElementById('accuracy');
            const eventLog = document.getElementById('event-log');
            const startButton = document.getElementById('start-button');
            const stopButton = document.getElementById('stop-button');
            const modelSelect = document.getElementById('model-select');
            const datasetSelect = document.getElementById('dataset-select');
            const chartCanvas = document.getElementById('detection-chart');

            // --- State variables ---
            let totalWindows = 0;
            let correctPredictions = 0;
            let detectionCounts = {};
            const MAX_LOG_ENTRIES = 50;

            // --- Chart.js Setup ---
            const chartCtx = chartCanvas.getContext('2d');
            const detectionChart = new Chart(chartCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, ticks: { color: '#9ca3af', stepSize: 1 }, grid: { color: 'rgba(75, 85, 99, 0.5)' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            function updateChart() {
                const sortedLabels = Object.keys(detectionCounts).sort((a, b) => detectionCounts[b] - detectionCounts[a]);
                const sortedData = sortedLabels.map(label => detectionCounts[label]);
                const backgroundColors = sortedLabels.map(label => (label.includes('attack') && !label.includes('free')) ? 'rgba(239, 68, 68, 0.6)' : 'rgba(16, 185, 129, 0.6)');
                
                detectionChart.data.labels = sortedLabels.map(l => l.replace(/-/g, ' '));
                detectionChart.data.datasets[0].data = sortedData;
                detectionChart.data.datasets[0].backgroundColor = backgroundColors;
                detectionChart.update();
            }

            function setControlsState(isSimulating) {
                startButton.disabled = isSimulating;
                stopButton.disabled = !isSimulating;
                modelSelect.disabled = isSimulating;
                datasetSelect.disabled = isSimulating;
                startButton.textContent = isSimulating ? 'Running...' : 'Start';
            }

            // --- Event Listeners ---
            startButton.addEventListener('click', () => {
                setControlsState(true);
                totalWindows = 0; correctPredictions = 0; detectionCounts = {};
                totalWindowsEl.textContent = '0'; accuracyEl.textContent = '0%';
                eventLog.innerHTML = ''; statusText.textContent = 'STARTING...';
                trueLabelEl.textContent = '-'; resultTextEl.textContent = '-';
                updateChart();
                socket.emit('start_simulation', { model: modelSelect.value, dataset: datasetSelect.value });
            });

            stopButton.addEventListener('click', () => {
                socket.emit('stop_simulation');
                stopButton.textContent = 'Stopping...';
            });

            // --- Socket.IO Handlers ---
            socket.on('simulation_status', (data) => {
                if (data.status === 'finished' || data.status === 'error' || data.status === 'stopped') {
                    setControlsState(false);
                    stopButton.textContent = 'Stop';
                    statusText.textContent = data.status.toUpperCase();
                    statusBox.className = 'p-6 rounded-lg text-center transition-all duration-300 status-idle';
                }
            });

            socket.on('live_update', (data) => {
                const predictionClean = data.prediction.replace(/-/g, ' ').toUpperCase();
                statusText.textContent = predictionClean;
                const isAttack = data.prediction.includes('attack') && !data.prediction.includes('free');
                
                statusBox.className = `p-6 rounded-lg text-center transition-all duration-300 ${isAttack ? 'status-attack' : 'status-normal'}`;
                statusBox.classList.toggle('pulse', isAttack);

                trueLabelEl.textContent = data.true_label.replace(/-/g, ' ').toUpperCase();
                resultTextEl.textContent = data.is_correct ? 'CORRECT' : 'INCORRECT';
                resultTextEl.className = `text-lg font-bold ${data.is_correct ? 'correct' : 'incorrect'}`;

                totalWindows++;
                if (data.is_correct) correctPredictions++;
                totalWindowsEl.textContent = totalWindows;
                const accuracy = totalWindows > 0 ? ((correctPredictions / totalWindows) * 100).toFixed(1) : 0;
                accuracyEl.textContent = `${accuracy}%`;

                detectionCounts[data.prediction] = (detectionCounts[data.prediction] || 0) + 1;
                updateChart();

                const newRow = document.createElement('tr');
                newRow.className = 'bg-gray-800/50 border-b border-gray-700/50';
                newRow.innerHTML = `
                    <td class="px-4 py-2">${data.timestamp}</td>
                    <td class="px-4 py-2">${data.prediction}</td>
                    <td class="px-4 py-2">${data.true_label}</td>
                    <td class="px-4 py-2 font-bold ${data.is_correct ? 'correct' : 'incorrect'}">${data.is_correct ? '✓' : '✗'}</td>
                `;
                eventLog.prepend(newRow);
                if (eventLog.children.length > MAX_LOG_ENTRIES) {
                    eventLog.lastChild.remove();
                }
            });
        });
    </script>
</body>
</html>

